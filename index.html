<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç†è²¡ç›®æ¨™è¿½è¹¤å™¨ - è«è˜­è¿ªç‰ˆ</title>
    <link rel="icon" href="favicon.png" 
        type="image/png">
    <style>
        :root {
            /* è«è˜­è¿ªè‰²ç³»å®šç¾© */
            --bg-color: #f4f5f7; /* æ·ºç°èƒŒæ™¯ */
            --card-bg: #ffffff;
            --text-main: #5c5c5c; /* æ·±ç°å­—é«”ï¼Œä¸ä½¿ç”¨ç´”é»‘ */
            --text-light: #949494;
            
            --primary: #7c99ac; /* éœ§éœ¾è— */
            --primary-light: #dbe2e6;
            
            --success: #95b8a6; /* ç°è±†ç¶  (æ”¶å…¥) */
            --success-bg: #eaf2ee;
            
            --danger: #d48c8c; /* ä¹¾ç‡¥ç«ç‘° (æ”¯å‡º) */
            --danger-bg: #f7e8e8;
            
            --accent: #e0cda7; /* ç‡•éº¥å¥¶å’– (è­¦å‘Š/æç¤º) */
            --accent-bg: #f9f5ed;
            
            --border-radius: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background-color: var(--bg-color);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-main);
            line-height: 1.6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05); /* æŸ”å’Œé™°å½± */
        }

        h1 {
            text-align: center;
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 2.2em;
            font-weight: 600;
            letter-spacing: 1px;
        }

        .subtitle {
            text-align: center;
            color: var(--text-light);
            margin-bottom: 40px;
            font-size: 1em;
        }

        .section {
            background: #fafafa;
            padding: 30px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            border: 1px solid #eeeeee;
        }

        .section-title {
            font-size: 1.2em;
            color: var(--text-main);
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .section-title::before {
            content: '';
            display: block;
            width: 5px;
            height: 20px;
            background-color: var(--primary);
            border-radius: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-main);
            font-size: 0.9em;
        }

        input, select, textarea {
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            background: #fff;
            color: var(--text-main);
            transition: all 0.3s;
        }

        input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s;
            letter-spacing: 0.5px;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(124, 153, 172, 0.3);
        }

        .btn-success {
            background: var(--success);
        }
        .btn-success:hover {
            box-shadow: 0 5px 15px rgba(149, 184, 166, 0.3);
        }

        .btn-danger {
            background: var(--danger);
            padding: 6px 15px;
            font-size: 0.85em;
        }
        .btn-danger:hover {
            box-shadow: 0 5px 15px rgba(212, 140, 140, 0.3);
        }

        .btn-small {
            padding: 8px 20px;
            font-size: 0.9em;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            padding: 25px 15px;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            border: 1px solid #f0f0f0;
            transition: transform 0.3s;
        }
        
        .card:hover {
            transform: translateY(-3px);
        }

        .card-label {
            font-size: 0.85em;
            color: var(--text-light);
            margin-bottom: 8px;
            letter-spacing: 1px;
        }

        .card-value {
            font-size: 1.5em;
            font-weight: 600;
            color: var(--text-main);
        }

        .card.income .card-value { color: var(--success); }
        .card.expense .card-value { color: var(--danger); }
        .card.warning .card-value { color: var(--accent); }
        
        /* å¯é»æ“Šçš„å¡ç‰‡æ¨£å¼ */
        .card.clickable {
            cursor: pointer;
            position: relative;
        }
        .card.clickable:active {
            transform: scale(0.98);
        }
        .card.clickable::after {
            content: 'ğŸ‘† é»æ“ŠæŸ¥çœ‹è©³æƒ…';
            position: absolute;
            bottom: 5px;
            left: 0;
            width: 100%;
            font-size: 0.7em;
            color: #ddd;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .card.clickable:hover::after {
            opacity: 1;
        }

        .date-display {
            background: var(--accent-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            text-align: center;
            margin-bottom: 30px;
            color: #8c7b5d;
        }

        .date-display h3 {
            font-size: 1em;
            font-weight: normal;
            margin-bottom: 5px;
        }

        .countdown {
            font-size: 1.4em;
            font-weight: bold;
            color: #b59e72;
        }

        .progress-section {
            background: white;
            padding: 5px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
        }

        .progress-bar-container {
            background: #f0f0f0;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: var(--success); /* è«è˜­è¿ªç¶  */
            border-radius: 10px;
            transition: width 0.8s ease;
        }

        .transaction-form {
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            border: 1px dashed #d1d5db;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .radio-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px 20px;
            border-radius: 20px;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        
        .radio-label:hover {
            background: #f5f5f5;
        }

        /* è‡ªå®šç¾© Radio */
        input[type="radio"] {
            accent-color: var(--primary);
        }

        .transaction-list {
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.02);
        }

        .transaction-header {
            display: grid;
            grid-template-columns: 80px 140px 1fr 100px 70px; /* å¢åŠ æ™‚é–“æ¬„ä½å¯¬åº¦ */
            gap: 15px;
            padding: 15px 20px;
            background: #fafafa;
            color: var(--text-light);
            font-size: 0.85em;
            border-bottom: 1px solid #f0f0f0;
        }

        .transaction-item {
            display: grid;
            grid-template-columns: 80px 140px 1fr 100px 70px;
            gap: 15px;
            padding: 15px 20px;
            border-bottom: 1px solid #f9f9f9;
            align-items: center;
            transition: background 0.2s;
        }

        .transaction-item:hover {
            background: #fcfcfc;
        }

        .transaction-type {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.8em;
            text-align: center;
        }

        .type-income {
            background: var(--success-bg);
            color: #6b8c7c;
        }

        .type-expense {
            background: var(--danger-bg);
            color: #b57b7b;
        }
        
        .transaction-date {
            font-size: 0.85em;
            color: var(--text-light);
            display: flex;
            flex-direction: column;
            line-height: 1.2;
        }
        
        .transaction-date span.time {
            font-size: 0.9em;
            color: #b0b0b0;
        }

        .transaction-reason {
            color: var(--text-main);
            font-size: 0.95em;
        }

        .transaction-amount {
            font-weight: 600;
            text-align: right;
        }

        .amount-income { color: var(--success); }
        .amount-expense { color: var(--danger); }

        .method-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: white;
            margin-bottom: 10px;
            border-radius: 12px;
            border: 1px solid #f0f0f0;
            transition: all 0.3s;
        }

        .method-item.completed {
            background: #f9f9f9;
            opacity: 0.7;
        }

        .method-item.completed .method-text {
            text-decoration: line-through;
            color: var(--text-light);
        }
        
        /* éŸ¿æ‡‰å¼èª¿æ•´ */
        @media (max-width: 768px) {
            .container { padding: 20px; }
            .transaction-header { display: none; } /* æ‰‹æ©Ÿç‰ˆéš±è—æ¨™é¡Œ */
            .transaction-item {
                grid-template-columns: 1fr 100px;
                grid-template-rows: auto auto auto;
                gap: 5px;
                padding: 15px;
            }
            .transaction-type { grid-column: 1; width: fit-content; margin-bottom: 5px;}
            .transaction-date { grid-column: 2; text-align: right; grid-row: 1; }
            .transaction-reason { grid-column: 1 / -1; font-weight: 500; margin: 5px 0;}
            .transaction-amount { grid-column: 1; text-align: left; font-size: 1.1em;}
            .transaction-actions { grid-column: 2; text-align: right; }
        }

        .celebration {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            text-align: center;
            display: none;
            z-index: 1000;
            border: 2px solid var(--success);
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(2px);
            display: none;
            z-index: 999;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ ç†è²¡ç›®æ¨™è¿½è¹¤</h1>
        <p class="subtitle">å„ªé›…åœ°è¨˜éŒ„æ¯ä¸€ç­†ç”Ÿæ´»ï¼Œæœç›®æ¨™å‰é€²</p>
        
        <div class="section">
            <h2 class="section-title">ğŸ“‹ ç›®æ¨™è¨­å®š</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label>ç›®æ¨™åç¨±</label>
                    <input type="text" id="goalName" placeholder="ä¾‹å¦‚ï¼šåŒ—æ­ä¹‹æ—…ã€ç¬¬ä¸€æ¡¶é‡‘">
                </div>
                <div class="input-group">
                    <label>ç›®æ¨™é‡‘é¡ (NT$)</label>
                    <input type="number" id="targetAmount" placeholder="100000">
                </div>
                <div class="input-group">
                    <label>ç›®æ¨™æ—¥æœŸ</label>
                    <input type="date" id="targetDate">
                </div>
                <div class="input-group">
                    <label>èµ·å§‹é‡‘é¡ (NT$)</label>
                    <input type="number" id="initialAmount" placeholder="0" value="0">
                </div>
            </div>
            <div style="text-align: center;">
                <button class="btn" onclick="saveGoal()">å„²å­˜è¨­å®š</button>
            </div>
        </div>

        <div class="date-display" id="dateDisplay" style="display: none;">
            <h3>â° è·é›¢ç›®æ¨™æ—¥æœŸé‚„æœ‰</h3>
            <div class="countdown" id="countdownText">è¨ˆç®—ä¸­...</div>
        </div>

        <div class="progress-section" id="progressSection" style="display: none;">
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar" style="width: 0%"></div>
            </div>
        </div>

        <div class="dashboard" id="dashboard" style="display: none;">
            <div class="card">
                <div class="card-label">ç›®å‰ç¸½é¡</div>
                <div class="card-value" id="totalAmount">NT$ 0</div>
            </div>
            <div class="card income">
                <div class="card-label">ç´¯è¨ˆæ”¶å…¥</div>
                <div class="card-value positive" id="totalIncome">NT$ 0</div>
            </div>
            <div class="card expense">
                <div class="card-label">ç´¯è¨ˆæ”¯å‡º</div>
                <div class="card-value negative" id="totalExpense">NT$ 0</div>
            </div>
            <div class="card warning">
                <div class="card-label">é‚„å·®é‡‘é¡</div>
                <div class="card-value" id="remainingAmount">NT$ 0</div>
            </div>
            <div class="card">
                <div class="card-label">æ¯æ—¥éœ€å­˜</div>
                <div class="card-value" id="dailyNeed">NT$ 0</div>
            </div>
            <div class="card clickable" onclick="toggleProgressDetail()" title="é»æ“Šåˆ‡æ›ç²¾ç¢ºåº¦">
                <div class="card-label">å®Œæˆé€²åº¦</div>
                <div class="card-value" id="progressPercent">0%</div>
            </div>
        </div>

        <div class="section" id="transactionSection" style="display: none;">
            <h2 class="section-title">ğŸ’° æ”¶æ”¯è¨˜éŒ„</h2>
            
            <div class="transaction-form">
                <div class="radio-group">
                    <label class="radio-label">
                        <input type="radio" name="transType" value="income" checked>
                        <span>æ”¶å…¥ (+)</span>
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="transType" value="expense">
                        <span>æ”¯å‡º (-)</span>
                    </label>
                </div>
                <div class="form-grid">
                    <div class="input-group">
                        <label>é‡‘é¡ (NT$)</label>
                        <input type="number" id="transAmount" placeholder="1000">
                    </div>
                    <div class="input-group">
                        <label>æ—¥æœŸ</label>
                        <input type="date" id="transDate">
                    </div>
                    <div class="input-group">
                        <label>æ™‚é–“</label>
                        <input type="time" id="transTime">
                    </div>
                    <div class="input-group" style="grid-column: 1 / -1;">
                        <label>ç†ç”± / èªªæ˜</label>
                        <input type="text" id="transReason" placeholder="ä¾‹å¦‚ï¼šè–ªæ°´ã€æ™šé¤ã€è²·æ›¸...">
                    </div>
                </div>
                <div style="text-align: right;">
                    <button class="btn btn-success" onclick="addTransaction()">æ–°å¢è¨˜éŒ„</button>
                </div>
            </div>

            <div class="transaction-list">
                <div class="transaction-header">
                    <div>é¡å‹</div>
                    <div>æ—¥æœŸæ™‚é–“</div>
                    <div>ç†ç”± / èªªæ˜</div>
                    <div style="text-align: right">é‡‘é¡</div>
                    <div style="text-align: center">æ“ä½œ</div>
                </div>
                <div id="transactionList">
                    <div style="padding: 40px; text-align: center; color: #999;">å°šç„¡äº¤æ˜“è¨˜éŒ„</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">ğŸ“ åŠªåŠ›ç­†è¨˜</h2>
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <input type="text" id="newMethod" placeholder="ä¾‹å¦‚ï¼šæ¯å¤©å°‘å–ä¸€æ¯é£²æ–™..." style="flex:1;">
                <button class="btn btn-small" onclick="addMethod()">æ–°å¢</button>
            </div>
            <ul style="list-style: none;" id="methodList"></ul>
        </div>
    </div>

    <div class="overlay" id="overlay" onclick="closeCelebration()"></div>
    <div class="celebration" id="celebration">
        <div style="font-size: 3em; margin-bottom: 10px;">ğŸ‰</div>
        <h2 style="color: var(--success); margin-bottom: 10px;">æ­å–œé”æˆç›®æ¨™ï¼</h2>
        <p style="color: var(--text-main); margin-bottom: 10px;">å¦³çš„å …æŒæœ‰äº†å›å ±</p>
        <p style="color: var(--primary); font-size: 1.2em; font-weight: bold;" id="celebrationAmount"></p>
        <button class="btn" onclick="closeCelebration()" style="margin-top: 20px;">å¤ªæ£’äº†ï¼</button>
    </div>

    <script>
        let appData = {
            goal: {
                name: '',
                targetAmount: 0,
                targetDate: '',
                initialAmount: 0
            },
            transactions: [],
            methods: []
        };
        
        let showPreciseProgress = false; // æ§åˆ¶æ˜¯å¦é¡¯ç¤ºç²¾ç¢ºç™¾åˆ†æ¯”

        // åˆå§‹åŒ–æ—¥æœŸæ™‚é–“
        document.getElementById('targetDate').valueAsDate = new Date(Date.now() + 180 * 24 * 60 * 60 * 1000);
        
        // è¨­å®šä»Šå¤©çš„æ—¥æœŸèˆ‡ç¾åœ¨çš„æ™‚é–“
        const now = new Date();
        document.getElementById('transDate').valueAsDate = now;
        document.getElementById('transTime').value = now.toTimeString().slice(0, 5); // HH:mm format

        function saveGoal() {
            const name = document.getElementById('goalName').value || 'æˆ‘çš„ç†è²¡ç›®æ¨™';
            const target = parseFloat(document.getElementById('targetAmount').value) || 0;
            const initial = parseFloat(document.getElementById('initialAmount').value) || 0;
            const date = document.getElementById('targetDate').value;

            if (target <= 0) {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„ç›®æ¨™é‡‘é¡ï¼');
                return;
            }

            appData.goal = { name, targetAmount: target, targetDate: date, initialAmount: initial };
            
            // è™•ç†åˆå§‹é‡‘é¡
            if (initial > 0) {
                // æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰åˆå§‹äº¤æ˜“ï¼Œè‹¥ç„¡å‰‡æ–°å¢
                const hasInitial = appData.transactions.some(t => t.reason === 'åˆå§‹é‡‘é¡');
                if (!hasInitial) {
                    appData.transactions.push({
                        id: Date.now(),
                        type: 'income',
                        amount: initial,
                        date: new Date().toISOString().split('T')[0],
                        time: '00:00',
                        reason: 'åˆå§‹é‡‘é¡'
                    });
                }
            }

            updateAll();
            saveToStorage();
        }

        function addTransaction() {
            const type = document.querySelector('input[name="transType"]:checked').value;
            const amount = parseFloat(document.getElementById('transAmount').value);
            const date = document.getElementById('transDate').value;
            const time = document.getElementById('transTime').value; // ç²å–æ™‚é–“
            const reason = document.getElementById('transReason').value.trim();

            if (!amount || amount <= 0) {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡ï¼');
                return;
            }
            if (!reason) {
                alert('è«‹è¼¸å…¥ç†ç”±æˆ–èªªæ˜ï¼');
                return;
            }

            appData.transactions.push({
                id: Date.now(),
                type,
                amount,
                date,
                time: time || '00:00', // å„²å­˜æ™‚é–“ï¼Œè‹¥ç„¡å‰‡é è¨­
                reason
            });

            // é‡ç½®è¡¨å–®ç‚ºç¾åœ¨æ™‚é–“
            document.getElementById('transAmount').value = '';
            document.getElementById('transReason').value = '';
            const currentNow = new Date();
            document.getElementById('transDate').valueAsDate = currentNow;
            document.getElementById('transTime').value = currentNow.toTimeString().slice(0, 5);

            updateAll();
            saveToStorage();

            const currentTotal = calculateTotal();
            if (currentTotal >= appData.goal.targetAmount && appData.goal.targetAmount > 0) {
                showCelebration(currentTotal);
            }
        }

        function deleteTransaction(id) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜éŒ„å—ï¼Ÿ')) {
                appData.transactions = appData.transactions.filter(t => t.id !== id);
                updateAll();
                saveToStorage();
            }
        }

        function calculateTotal() {
            let total = 0;
            appData.transactions.forEach(t => {
                if (t.type === 'income') total += t.amount;
                else total -= t.amount;
            });
            return total;
        }
        
        // åˆ‡æ›é€²åº¦é¡¯ç¤ºæ¨¡å¼
        function toggleProgressDetail() {
            showPreciseProgress = !showPreciseProgress;
            updateAll(); // é‡æ–°æ¸²æŸ“ä»‹é¢
        }

        function updateAll() {
            if (!appData.goal.targetAmount) return;

            const total = calculateTotal();
            const target = appData.goal.targetAmount;
            const remaining = Math.max(0, target - total);
            
            // è¨ˆç®—ç™¾åˆ†æ¯”
            const rawPercent = (total / target) * 100;
            let percentDisplay;
            
            if (showPreciseProgress) {
                // ç²¾ç¢ºæ¨¡å¼ï¼šå°æ•¸é»å¾Œå…©ä½
                percentDisplay = rawPercent.toFixed(2) + '%';
            } else {
                // ä¸€èˆ¬æ¨¡å¼ï¼šæ•´æ•¸ï¼Œæœ€å¤§ä¸è¶…é 100% (é™¤éçœŸçš„è¶…é)
                percentDisplay = Math.min(100, Math.round(rawPercent)) + '%';
                if (rawPercent > 100) percentDisplay = Math.round(rawPercent) + '%';
            }

            const today = new Date();
            const targetDate = new Date(appData.goal.targetDate);
            const diffTime = targetDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            document.getElementById('dateDisplay').style.display = 'block';
            const countdownText = diffDays > 0 
                ? `${diffDays} å¤©ï¼ˆ${targetDate.toLocaleDateString('zh-TW')}ï¼‰`
                : diffDays === 0 
                    ? 'å°±æ˜¯ä»Šå¤©ï¼'
                    : `å·²éæœŸ ${Math.abs(diffDays)} å¤©`;
            document.getElementById('countdownText').textContent = countdownText;

            document.getElementById('dashboard').style.display = 'grid';
            document.getElementById('totalAmount').textContent = `NT$ ${total.toLocaleString()}`;
            document.getElementById('remainingAmount').textContent = `NT$ ${remaining.toLocaleString()}`;
            
            // æ›´æ–°é€²åº¦é¡¯ç¤º
            document.getElementById('progressPercent').textContent = percentDisplay;

            const dailyNeed = diffDays > 0 ? Math.ceil(remaining / diffDays) : 0;
            document.getElementById('dailyNeed').textContent = diffDays > 0 ? `NT$ ${dailyNeed.toLocaleString()}` : '-';

            document.getElementById('progressSection').style.display = 'block';
            // é€²åº¦æ¢é•·åº¦ä¸Šé™é–å®šåœ¨ 100% ä»¥å…è·‘ç‰ˆ
            document.getElementById('progressBar').style.width = Math.min(100, Math.max(0, rawPercent)) + '%';

            let totalIncome = 0, totalExpense = 0;
            appData.transactions.forEach(t => {
                if (t.type === 'income') totalIncome += t.amount;
                else totalExpense += t.amount;
            });

            document.getElementById('totalIncome').textContent = `NT$ ${totalIncome.toLocaleString()}`;
            document.getElementById('totalExpense').textContent = `NT$ ${totalExpense.toLocaleString()}`;

            renderTransactions();
            document.getElementById('transactionSection').style.display = 'block';
        }

        function renderTransactions() {
            const list = document.getElementById('transactionList');
            
            if (appData.transactions.length === 0) {
                list.innerHTML = '<div style="padding: 40px; text-align: center; color: #999;">å°šç„¡äº¤æ˜“è¨˜éŒ„</div>';
                return;
            }

            // æ’åºé‚è¼¯ï¼šæ—¥æœŸ + æ™‚é–“ (æ–°åˆ°èˆŠ)
            const sorted = [...appData.transactions].sort((a, b) => {
                // çµ„åˆæ—¥æœŸèˆ‡æ™‚é–“å­—ä¸²é€²è¡Œæ¯”è¼ƒ
                const timeA = a.time || '00:00';
                const timeB = b.time || '00:00';
                const dateA = new Date(`${a.date}T${timeA}`);
                const dateB = new Date(`${b.date}T${timeB}`);
                return dateB - dateA;
            });

            list.innerHTML = sorted.map(t => {
                const timeStr = t.time ? `<span class="time">${t.time}</span>` : '';
                return `
                <div class="transaction-item">
                    <div class="transaction-type ${t.type === 'income' ? 'type-income' : 'type-expense'}">
                        ${t.type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º'}
                    </div>
                    <div class="transaction-date">
                        ${t.date}
                        ${timeStr}
                    </div>
                    <div class="transaction-reason">${t.reason}</div>
                    <div class="transaction-amount ${t.type === 'income' ? 'amount-income' : 'amount-expense'}">
                        ${t.type === 'income' ? '+' : '-'} ${t.amount.toLocaleString()}
                    </div>
                    <div class="transaction-actions" style="text-align: center;">
                        <button class="btn btn-danger" onclick="deleteTransaction(${t.id})">Ã—</button>
                    </div>
                </div>
            `}).join('');
        }

        function addMethod() {
            const input = document.getElementById('newMethod');
            const text = input.value.trim();
            if (!text) return;

            appData.methods.push({
                id: Date.now(),
                text,
                completed: false
            });
            input.value = '';
            renderMethods();
            saveToStorage();
        }

        function toggleMethod(id) {
            const method = appData.methods.find(m => m.id === id);
            if (method) {
                method.completed = !method.completed;
                renderMethods();
                saveToStorage();
            }
        }

        function deleteMethod(id) {
            appData.methods = appData.methods.filter(m => m.id !== id);
            renderMethods();
            saveToStorage();
        }

        function renderMethods() {
            const list = document.getElementById('methodList');
            if (appData.methods.length === 0) {
                list.innerHTML = '<li style="text-align:center; color:#ccc; padding:10px;">å°šæœªæ–°å¢ä»»ä½•æ–¹æ³•</li>';
                return;
            }

            list.innerHTML = appData.methods.map(m => `
                <li class="method-item ${m.completed ? 'completed' : ''}">
                    <label style="display:flex; align-items:center; gap:10px; cursor:pointer; flex:1;">
                        <input type="checkbox" ${m.completed ? 'checked' : ''} 
                               onchange="toggleMethod(${m.id})"
                               style="width:18px; height:18px; accent-color: var(--primary);">
                        <span class="method-text">${m.text}</span>
                    </label>
                    <button class="btn btn-danger" onclick="deleteMethod(${m.id})">åˆªé™¤</button>
                </li>
            `).join('');
        }

        function showCelebration(amount) {
            document.getElementById('celebrationAmount').textContent = `ç´¯ç©é‡‘é¡ï¼šNT$ ${amount.toLocaleString()}`;
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('celebration').style.display = 'block';
        }

        function closeCelebration() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('celebration').style.display = 'none';
        }

        function saveToStorage() {
            localStorage.setItem('financeGoalPro_v2', JSON.stringify(appData));
        }

        window.addEventListener('load', function() {
            // å˜—è©¦è®€å–æ–°ç‰ˆè³‡æ–™
            let saved = localStorage.getItem('financeGoalPro_v2');
            
            // å¦‚æœæ²’æœ‰æ–°ç‰ˆè³‡æ–™ï¼Œå˜—è©¦è®€å–èˆŠç‰ˆè³‡æ–™ (ç›¸å®¹æ€§è™•ç†)
            if (!saved) {
                saved = localStorage.getItem('financeGoalPro');
                if (saved) {
                    // å¦‚æœæ˜¯èˆŠè³‡æ–™ï¼Œæˆ‘å€‘å°‡å®ƒè½‰æ›éä¾†ï¼Œä½†ä¸åˆªé™¤èˆŠçš„ä»¥é˜²è¬ä¸€
                    console.log("Migrating old data...");
                }
            }

            if (saved) {
                appData = JSON.parse(saved);
                document.getElementById('goalName').value = appData.goal.name;
                document.getElementById('targetAmount').value = appData.goal.targetAmount;
                document.getElementById('targetDate').value = appData.goal.targetDate;
                document.getElementById('initialAmount').value = appData.goal.initialAmount;
                
                if (appData.goal.targetAmount > 0) {
                    updateAll();
                    renderMethods();
                }
            }
        });

        document.getElementById('newMethod').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addMethod();
        });
        document.getElementById('transReason').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addTransaction();
        });
    </script>
</body>
</html>
